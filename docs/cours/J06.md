# J06 - Sequelize Model

## Menu du jour

```
- Correction challenge
  - Tous les mod√®les Sequelize
  - R√©visions Git et branches

- Associations Sequelize
  - Mise en place
  - Quelques tests

- R√©visions
  - Pages d'administration des levels
  - Ocode :
    - Requ√™tes complexes (jointures)
    - Lutins (Sequelize, mise en place des models et associations => fin de saison (vendredi ?))

- Oquiz is alive !
  - √ânonc√© **atelier PP**
  - Pas de challenge üéâ
```

## M√©thode de classe vs m√©thode d'instance

```js
class SuperHero {
  height;
  superpower;

  constructor(...) { ... }

  // M√©thode d'instance => des m√©thodes qu'on appelle sur UNE instance de SuperHero
  fly() { ... }
  eat() { ... }
  saveTheWorld() { ... }

  // M√©thode de classe
  getGeneralInfo() { ... }
}


// Cr√©er une instance
const peter = new SuperHero(190, "lancer des toiles d'araign√©e");
peter.fly(); 
peter.eat();
peter.saveTheWorld();

// Appeler une m√©thode de classe
SuperHero.getGeneralInfo(); // il y a actuellement 150 super h√©ros pr√©sents.

```

## Sequelize

```js
// === CREATE ===
const bob = new User({ name: "Bob", email: "bob@bikini.io" });
await bob.save(); // Cr√©er l'enregistrement en BDD

// === CREATE (*) ===
const patrick = await User.create({ name: "Patrick", "patrick@bikini.io" });

// === UPDATE ===
bob.email = "bob.leponge@bikini.io";
await bob.save(); // Modifie l'enregistrement en BDD

// === UPDATE (*) ===
await bob.set("name", "Bob l'√âponge"); // Modifie l'instance + le persiste en base du m√™me coup 

// === DELETE ===
await bob.destroy(); // Supprime l'enregistrement de la BDD
```


```js
const { Sequelize } = require("sequelize");
//                    ^ module Sequelize

const sequelize = new Sequelize(...);
//    ^ instance de connexion = tunnel vers la BDD !


const sequelize = new Sequelize(process.env.PG_URL)
//                              ^ l'adresse de la BDD Postgres

const sequelize = new Sequelize(process.env.PG_URL)
//                ^ constructeur de la classe Sequelize

```

## DataTypes Sequelize

[Documentation pour la correspondance entre les types Sequelize et les types Postgres](https://sequelize.org/docs/v7/models/data-types/)

```js
const { DataTypes } = require("sequelize");

// Types "chaine de caract√®res"
DataTypes.TEXT          // TEXT (chaine de caract√®res sans limite)
DataTypes.STRING        // VARCHAR(255) (chaine de caract√®re de moins de 255 caract√®res)
DataTypes.STRING(100)   // VARCHAR(100)
DataTypes.CHAR          // CHAR(255) (chaine de caract√®re de 255 caract√®res tout pile !)
DataTypes.CHAR(7)       // CHAR(7) (chaine de caract√®res de 7 caract√®res tout pile !)

// Types "nombre"
DataTypes.INTEGER       // INTEGER (nombre entier)
DataTypes.FLOAT         // REAL (nombre √† virgule)

```


## Convention en JS

- Nom de classe : `PascalCase`
- Nom d'instance === nom de variable : `camelCase`

```js
class Cat {} // PascalCase

const garfield = new Cat(...); // camelCase
```


## Associations

Rappel : deux entit√©s peuvent √™tre li√©es par une "association". Il existe plusieurs types d'associations : 
- `One-to-One`
- `One-To-Many`
- `Many-To-Many`

Documentation pour repr√©senter ces associations dans Sequelize : [ici](https://sequelize.org/docs/v6/core-concepts/assocs/)

Deux √©tapes : 
- 1) D√©finir nos associations (par exemple dans `association.js`)
  - pourquoi dans un fichier √† part ? pour √©viter qu'un mod√®le A require un mod√®le B
- 2) Utiliser nos assocations (`include`)

## Particularit√© d'Oquiz

Dans le cadre du cours, on a √©crit le fichier SQL √† la main pour apprendre √† utiliser SQL (ex : `CREATE TABLE` / `INSERT TO`).

Puis on a branch√© Sequelize et on essaie de **se greffer sur la base Postgres existante**.

Il est tout √† fait possible de ne pas √©crire le fichier SQL et laisser Sequelize g√©rer la cr√©ation des tables (cf. S12) (ex : `sequelize.sync()`).

### Jointures SQL

L'id√©e : r√©cup√©rer les donn√©es d'une table, et dans la **m√™me requ√™te** r√©cup√©rer √©galement les donn√©es d'une autre table associ√©e.

Ex: 

```sql
SELECT * FROM "user"
JOIN "quiz"
ON "user"."id" = "quiz"."author_id"
WHERE "user"."id" = 1;
```

Conseils : 
- tester progressivement la construction. 
  - par exemple ici : 
    - `SELECT * FROM "user";`
    - `SELECT * FROM "user" JOIN "quiz" ON "quiz"."author_id" = "user"."id";` (-> observer vos tables !)
    - `SELECT * FROM "user" JOIN "quiz" ON "user"."id" = "quiz"."author_id" WHERE "user"."id" = 1;`
- jointures AVANT les √©ventuels filtrages et groupement.

Exercices possibles : `ocode 05.Database/03.jointures` et le suivant


## Observer les donn√©es r√©cup√©r√©es de sequelize

- Si c'est un objet : 
  - `level.toJSON()`
  - `level.get()`

- Si c'est un tableau (d'objet) : 
  - `JSON.stringify(levels, null, 2)`
  ou bien
  - `levels.map(level => level.toJSON())`
  - `levels.map(level => level.get())`


## Injection SQL et ORM ? 

Bonne nouvelle, √† **condition qu'il soit √† jour**, notre ORM va √©viter les potentielle injection SQL !

```js
const newTagName = req.body.tag;

await Tag.create({ name: newTagName });


// User 1 (üòá) : `Cuisine`

// User 2 (üòà) : `1; DROP TABLE "user"; --`
```



## Include `options`

```js
Model.findAll({ include: "property" });

// Equivalent => avantage, on peut inclure plusieurs props
Model.findAll({ include: ["property"] })

// Equivalent => avantage, on peut mettre un second include
Model.findAll({ include: { association: "property" } })

// Equivalent => avantage, on peut mettre plusieurs proprietes et plusieurs includes !
Model.findAll({ include: [{ association: "property" }] })
```


```js
await Question.findByPk(1, {
  include: [
    { association: "level" },
    { association: "quiz", include: ["tags", "author"] },
  ]
});
```


```js
await Question.findByPk(1, {
  include: [
    { association: "level" },
    {
      association: "quiz",
      include: [
        { association: "tags", limit: 2 },
        { association: "author", attributes: ["firstname", "lastname"] }
      ]
    },
  ]
});
```

Conseil : 
- Ecrire petit √† petit :
  - r√©cup√©rer la question 1
  - puis inclure le lvl
  - puis inclure le lvl et le quiz
  - puis include le lvl, et le quiz avec la seconde syntaxe
  - puis include le lvl, et le quiz avec la seconde syntaxe et le tags du quiz
  - puis include le lvl, et le quiz avec la seconde syntaxe et le tags+author du quiz
- Faites TRES attention √† l'indentation, car on a des objects dans des tableaux dans des objets dans des tableaux !

## Branches et PR

![](../screenshots/branches.png)

